<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:t="http://myfaces.apache.org/tomahawk"
      xmlns:c="http://java.sun.com/jstl/core"
      xmlns:fn="http://java.sun.com/jstl/functions"
      xmlns:tr="http://myfaces.apache.org/trinidad"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:eye="http://taglib.eyeline.mobi">

<ui:composition template="/templates/main.xhtml">

  <ui:param name="pageTitle" value="#{msg['delivery.edit']}"/>

  <ui:define name="content">

    <tr:form>

      <eye:buttons>
        <eye:button>
          <tr:commandLink text="#{msg['done.button']}" action="#{deliveryEdit.save}"/>
        </eye:button>
        <eye:button>
          <tr:commandLink text="#{msg['cancel.button']}" action="#{deliveryEdit.cancel}" immediate="true"/>
        </eye:button>
        <eye:space/>
        <eye:button>
          <tr:commandLink text="#{msg['informer.stats']}" action="STATS_DELIVERY_MESSAGES_BY_PERIOD">
            <f:param name="delivery" value="#{deliveryEdit.delivery.id}"/>
          </tr:commandLink>
        </eye:button>
        <eye:button>
          <tr:commandLink text="#{msg['informer.deliveries.messages']}" action="MESSAGES">
            <f:param name="delivery" value="#{deliveryEdit.delivery.id}"/>
          </tr:commandLink>
        </eye:button>
      </eye:buttons>

      <tr:inputHidden id="delivery" value="#{deliveryEdit.id}"/>
      <tr:inputHidden id="delivery_comeback" value="#{deliveryEdit.comeBackParam}"/>

      <eye:delimiter/>
      
      <eye:pageSubtitle value="#{msg['delivery.edit.settings']}"/>

      <eye:delimiter/>

      <h:panelGrid columns="2" styleClass="properties_list" style="padding-left: 10px;border-bottom: 1px solid #E6E3D8;" columnClasses="column100Width, columnTopLeftAlign" >

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.name}"/>
        <tr:inputText value="#{deliveryEdit.delivery.name}" required="true" simple="true"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.owner}" rendered="#{deliveryEdit.userInAdminRole}"/>
        <h:outputText value="#{deliveryEdit.delivery.owner}" rendered="#{deliveryEdit.userInAdminRole}"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.sourceAddress}"/>
        <tr:inputText converter="addressConverter" value="#{deliveryEdit.delivery.sourceAddress}" required="true" simple="true"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.startDate}"/>
        <tr:outputText value="#{deliveryEdit.delivery.startDate}">
          <f:convertDateTime dateStyle="short" type="both"/>
        </tr:outputText>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.endDate}"/>
        <eye:inputDate value="#{deliveryEdit.delivery.endDate}" type="both"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.activeWeekDays}"/>
        <h:panelGrid columns="2" columnClasses="column100Width, columnTopLeftAlign">
          <h:selectManyCheckbox value="#{deliveryEdit.delivery.activeWeekDays}" required="true" requiredMessage="#{deliveryBundle.activeWeekDays}" converter="weekDaysConverter">
            <f:selectItems value="#{deliveryEdit.allDays}"/>
          </h:selectManyCheckbox>
          <h:outputText value="&#160;"/>
        </h:panelGrid>

        <h:outputText style="white-space:nowrap;" value="#{msg['delivery.edit.activity.period']}"/>
        <h:panelGroup>
          <eye:inputDate value="#{deliveryEdit.activePeriodStart}" required="true" type="short_time"/>
          <h:outputText value=" - "/>
          <eye:inputDate value="#{deliveryEdit.activePeriodEnd}" required="true" type="short_time"/>
        </h:panelGroup>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.priority}"/>
        <tr:inputText value="#{deliveryEdit.delivery.priority}" simple="true" required="true" columns="5">
          <tr:validateLongRange minimum="1" maximum="1000"/>
        </tr:inputText>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.retryPolicy}"/>
        <h:panelGroup>
          <h:selectOneMenu id="retryOnFail" onchange="retryOnFailChanged()" value="#{deliveryEdit.retryOnFail}">
            <f:selectItem itemValue="off" itemLabel="#{msg['user.edit.retry.off']}"/>
            <f:selectItem itemValue="default" itemLabel="#{msg['user.edit.retry.default']}"/>
            <f:selectItem itemValue="custom" itemLabel="#{msg['user.edit.retry.custom']}"/>
          </h:selectOneMenu>
          <h:outputText value=" "/>
          <h:inputText value="#{deliveryEdit.delivery.retryPolicy}" id="retryPolicy1"/>
        </h:panelGroup>

        <h:outputText id="vPeriodLabel" style="white-space:nowrap;" value="#{deliveryBundle.validityPeriod}"/>
        <eye:inputDate id="vPeriod" value="#{deliveryEdit.validityPeriod}" type="short_time"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.smsNotificationAddress}"/>
        <h:panelGroup>
          <h:selectBooleanCheckbox id="smsNotif" value="#{deliveryEdit.smsNotificationCheck}" onchange="document.getElementById('sms').disabled = !this.checked;" style="position: relative; top: 2px; left: -3px;"/>
          <tr:inputText id="sms" converter="addressConverter" value="#{deliveryEdit.smsNotificationAddress}" simple="true"/>
        </h:panelGroup>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.emailNotificationAddress}"/>
        <h:panelGroup>
          <h:selectBooleanCheckbox id="emailNotif" value="#{deliveryEdit.emailNotificationCheck}" onchange="document.getElementById('email').disabled = !this.checked;" style="position: relative; top: 2px; left: -3px;"/>
          <tr:inputText id="email" value="#{deliveryEdit.emailNotificationAddress}" simple="true"/>
        </h:panelGroup>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.singleText}" rendered="#{deliveryEdit.delivery.type.value == 'SingleText'}"/>
        <h:panelGrid columns="1" rendered="#{deliveryEdit.delivery.type.value == 'SingleText'}">
          <tr:inputText value="#{deliveryEdit.delivery.singleText}" rows="3" simple="true" required="true"/>
          <tr:commandLink text="#{msg['test.button']}" action="#{deliveryEdit.sendTest}"/>
        </h:panelGrid>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.secretMessage}" rendered="#{deliveryEdit.secret}"/>
        <tr:inputText rows="5" readOnly="true" value="#{deliveryEdit.secretMessage}"  simple="true" rendered="#{deliveryEdit.secret}"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.secretFlash}" rendered="#{deliveryEdit.secret}"/>
        <tr:selectBooleanCheckbox readOnly="true" value="#{deliveryEdit.flashSecret}" simple="true" rendered="#{deliveryEdit.secret}"/>
      
        <h:outputText style="white-space:nowrap; display: #{deliveryEdit.allowUssdPushDeliveries ? '' : 'none'}" value="#{deliveryBundle.deliveryMode}"/>
        <h:selectOneMenu id="dMode" value="#{deliveryEdit.delivery.deliveryMode}" required="true" converter="deliveryTypeConverter"
                         onchange="dModeChanged()"
                         style="display: #{deliveryEdit.allowUssdPushDeliveries ? '' : 'none'}">
          <f:selectItems value="#{deliveryEdit.uniqueDeliveryModes}"/>
        </h:selectOneMenu>

        <h:outputText id="flashLabel" style="white-space:nowrap;" value="#{deliveryBundle.flash}"/>
        <tr:selectBooleanCheckbox id="flash" value="#{deliveryEdit.delivery.flash}" simple="true"/>

        <h:outputText id="trModeLabel" style="white-space:nowrap;" value="#{deliveryBundle.transactionMode}"/>
        <tr:selectBooleanCheckbox id="trMode" value="#{deliveryEdit.delivery.transactionMode}" simple="true"/>

      </h:panelGrid>

      <eye:delimiter/>

      <eye:updatableContent  updatePeriod="5">

        <h:panelGrid columns="2" columnClasses="column50ProcWidthTop, columnTopLeftAlign">

          <h:panelGroup>

            <eye:pageSubtitle value="#{msg['delivery.edit.counters']}"/>

            <eye:delimiter/>

            <c:set var="total" value="0"/>
            <h:panelGrid columns="2" styleClass="properties_list" style="padding-left: 10px" columnClasses="column100WidthTopLeft, columnTopLeftAlign" >
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['delivery.messages.new']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.newMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.newMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['delivery.messages.process']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.processMessages + deliveryEdit.status.retriedMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.processMessages + deliveryEdit.status.retriedMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['delivery.messages.sent']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.sentMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.sentMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['delivery.messages.delivered']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.deliveredMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.deliveredMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['delivery.messages.failed']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.failedMessages + deliveryEdit.status.expiredMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.failedMessages + deliveryEdit.status.expiredMessages}"/>

              <h:outputText style="white-space:nowrap; font-weight: bold; border-bottom: 1px solid BLACK;" value="#{msg['delivery.messages.total']}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold; border-bottom: 1px solid BLACK;" value="#{total}"/>
            </h:panelGrid>

          </h:panelGroup>

          <h:panelGroup>
            <c:set var="nm" value="delivery.status.#{deliveryEdit.status.deliveryState.status}"/>

            <eye:pageSubtitle value="#{msg['delivery.edit.status']} : #{msg[nm]}"/>

            <eye:delimiter/>

            <h:panelGrid columns="2" styleClass="properties_list" style="padding-left: 10px" columnClasses="column100Width, columnTopLeftAlign" >
              <c:forEach items="#{deliveryEdit.statusHistory.historyItems}" var="item">

                <c:set var="nm1" value="delivery.status.#{item.status}"/>

                <tr:outputText value="#{item.date}" inlineStyle="white-space:nowrap;font-weight: bold">
                  <f:convertDateTime dateStyle="short" type="both"/>
                </tr:outputText>

                <h:outputText value=" : #{msg[nm1]}"/>
              </c:forEach>
            </h:panelGrid>
          </h:panelGroup>

        </h:panelGrid>

      </eye:updatableContent>

      <eye:delimiter/>

      <eye:buttons>
        <eye:button>
          <tr:commandLink text="#{msg['done.button']}" action="#{deliveryEdit.save}"/>
        </eye:button>
        <eye:button>
          <tr:commandLink text="#{msg['cancel.button']}" action="#{deliveryEdit.cancel}" immediate="true"/>
        </eye:button>
        <eye:space/>
        <eye:button>
          <tr:commandLink text="#{msg['informer.stats']}" action="STATS_DELIVERY_MESSAGES_BY_PERIOD">
            <f:param name="delivery" value="#{deliveryEdit.delivery.id}"/>
          </tr:commandLink>
        </eye:button>
        <eye:button>
          <tr:commandLink text="#{msg['informer.deliveries.messages']}" action="MESSAGES">
            <f:param name="delivery" value="#{deliveryEdit.delivery.id}"/>
          </tr:commandLink>
        </eye:button>
      </eye:buttons>

      <script type="text/javascript" language="javascript">

        function dModeChanged() {
          var d = (document.getElementById('dMode').value != 'SMS') ? 'none' : '';
          document.getElementById('flashLabel').style.display = d;
          document.getElementById('flash').style.display = d;
          document.getElementById('trModeLabel').style.display = d;
          document.getElementById('trMode').style.display = d;
        }

        function retryOnFailChanged() {
          var d = document.getElementById('retryOnFail').options[2].selected ? '' : 'none';
          document.getElementById('retryPolicy1').style.display=d;
        }

        retryOnFailChanged();

        dModeChanged();

        document.getElementById('sms').disabled = !document.getElementById('smsNotif').checked;
        document.getElementById('email').disabled = !document.getElementById('emailNotif').checked;
      </script>

    </tr:form>

  </ui:define>

</ui:composition>


</html>