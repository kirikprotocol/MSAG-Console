<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:c="http://java.sun.com/jstl/core"
      xmlns:tr="http://myfaces.apache.org/trinidad"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:eye="http://taglib.eyeline.mobi">

<ui:composition template="/templates/main.xhtml">

  <ui:param name="pageTitle" value="#{msg['delivery.edit']}"/>

  <ui:define name="content">

    <tr:form>

      <eye:buttons>
        <eye:button>
          <tr:commandLink text="#{msg['done.button']}" action="#{deliveryEdit.save}" shortDesc="#{msg['delivery.details.save']}"/>
        </eye:button>
        <eye:button>
          <tr:commandLink text="#{msg['cancel.button']}" action="#{deliveryEdit.cancel}" immediate="true" shortDesc="#{msg['delivery.details.cancel']}"/>
        </eye:button>
        <eye:space/>
        <eye:button>
          <eye:menubar label="#{msg['informer.deliveries.stats']} ...">
            <eye:menubaritem>
              <tr:commandLink text="#{msg['informer.stats.by.messages']}" action="#{deliveryMessagesByPeriod.setDeliveryParam}" shortDesc="#{msg['delivery.details.stats.mess']}">
                <f:param name="delivery" value="#{deliveryEdit.delivery.id}"/>
                <f:param name="stats_come_back" value="DELIVERY_EDIT"/>
                <f:param name="stats_come_back_params" value="#{deliveryEdit.delivery.id}|#{deliveryEdit.comeBackParam}"/>
              </tr:commandLink>
            </eye:menubaritem>
            <eye:menubaritem>
              <tr:commandLink text="#{msg['informer.stats.by.error']}" action="#{messErrors.setDeliveryParam}" actionListener="#{deliveryEdit.statForSelected}" shortDesc="#{msg['delivery.details.stats.errors']}">
                <f:param name="errors_stats_come_back" value="DELIVERY_EDIT"/>
                <f:param name="errors_stats_come_back_params" value="#{deliveryEdit.delivery.id}|#{deliveryEdit.comeBackParam}"/>
              </tr:commandLink>
            </eye:menubaritem>
          </eye:menubar>
        </eye:button>
        <eye:button>
          <tr:commandLink text="#{msg['informer.deliveries.messages']}" action="MESSAGES" shortDesc="#{msg['delivery.details.msgs']}">
            <f:param name="delivery" value="#{deliveryEdit.delivery.id}"/>
            <f:param name="#{deliveryEdit.messagesComeBackParamsName}" value="#{deliveryEdit.delivery.id}|#{deliveryEdit.comeBackParam}"/>
            <f:param name="#{deliveryEdit.messagesComeBackName}" value="DELIVERY_EDIT"/>
          </tr:commandLink>
        </eye:button>
      </eye:buttons>

      <tr:inputHidden id="delivery" value="#{deliveryEdit.id}"/>
      <tr:inputHidden id="delivery_comeback" value="#{deliveryEdit.comeBackParam}"/>

      <eye:delimiter/>

      <eye:pageSubtitle value="#{msg['delivery.edit.settings']}"/>

      <eye:delimiter/>

      <h:panelGrid columns="2" styleClass="properties_list" style="padding-left: 10px;" columnClasses="column100Width, columnTopLeftAlign" >

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.name}"/>
        <tr:inputText value="#{deliveryEdit.delivery.name}" simple="true"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.owner}" rendered="#{deliveryEdit.userInAdminRole}"/>

        <tr:panelGroupLayout rendered="#{deliveryEdit.userInAdminRole}">

          <h:outputText value="#{deliveryEdit.delivery.owner}"/>

          <tr:panelGroupLayout rendered="#{userSession.userInAdminRole}" shortDesc="#{msg['user.edit.title']}">
            <h:outputText value="&#160;"/>
            <h:outputText value="&#160;"/>
            <tr:commandLink text=">>" action="USER_EDIT" immediate="true" shortDesc="#{msg['user.details.show']}">
              <f:param name="user_edit_comeback" value="DELIVERY_EDIT"/>
              <f:param name="userId" value="#{deliveryEdit.delivery.owner}"/>
              <f:param name="user_edit_comeback_params" value="#{deliveryEdit.userComeBackParams}|#{deliveryEdit.comeBackParam}"/>
            </tr:commandLink>
          </tr:panelGroupLayout>

        </tr:panelGroupLayout>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.sourceAddress}"/>
        <h:inputText converterMessage="#{msg['invalid_param_value']} #{deliveryBundle.sourceAddress}" converter="addressConverter" value="#{deliveryEdit.delivery.sourceAddress}" disabled="#{not createDelivery.activePage.userInAdminRole}"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.createDate}"/>
        <eye:inputDate id="createDate" readonly="true" value="#{deliveryEdit.createDate}" type="both"/>

        <h:outputText value="&#160;"/>
        <h:outputText style="white-space:nowrap;"  value="(#{msg['delivery.in.timezone']} '#{deliveryEdit.serverTimezone}')"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.startDate}"/>
        <eye:inputDate id="startDate" readonly="true" value="#{deliveryEdit.startDate}" type="both"/>

        <h:outputText value="&#160;"/>
        <h:panelGroup>
          <h:outputText rendered="#{deliveryEdit.boundToLocalTIme}" style="white-space:nowrap;"  value="(#{msg['delivery.local.time']})"/>
          <h:outputText rendered="#{!deliveryEdit.boundToLocalTIme}" style="white-space:nowrap;"  value="(#{msg['delivery.in.timezone']} '#{deliveryEdit.serverTimezone}')"/>
        </h:panelGroup>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.endDate}"/>
        <eye:inputDate value="#{deliveryEdit.delivery.endDate}" type="both"/>

        <h:outputText value="&#160;"/>
        <h:panelGroup>
          <h:outputText rendered="#{deliveryEdit.boundToLocalTIme}" style="white-space:nowrap;"  value="(#{msg['delivery.local.time']})"/>
          <h:outputText rendered="#{!deliveryEdit.boundToLocalTIme}" style="white-space:nowrap;"  value="(#{msg['delivery.in.timezone']} '#{deliveryEdit.serverTimezone}')"/>
        </h:panelGroup>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.activeWeekDays}"/>
        <h:panelGrid columns="2" columnClasses="column100Width, columnTopLeftAlign">
          <h:selectManyCheckbox converterMessage="#{msg['invalid_param_value']} #{deliveryBundle.activeWeekDays}"
              value="#{deliveryEdit.delivery.activeWeekDays}" converter="weekDaysConverter">
            <f:selectItems value="#{deliveryEdit.allDays}"/>
          </h:selectManyCheckbox>
          <h:outputText value="&#160;"/>
        </h:panelGrid>


          <h:outputText style="white-space:nowrap;" value="#{msg['delivery.edit.activity.period']}"/>
          <h:panelGroup>
            <eye:inputDate value="#{deliveryEdit.activePeriodStart}" type="short_time"/>
            <h:outputText value=" - "/>
            <eye:inputDate value="#{deliveryEdit.activePeriodEnd}" type="short_time"/>
          </h:panelGroup>

          <h:outputText rendered="#{deliveryEdit.userInAdminRole}" style="white-space:nowrap;" value="#{deliveryBundle.priority}"/>
          <h:inputText rendered="#{deliveryEdit.userInAdminRole}" converterMessage="#{msg['invalid_param_value']} #{deliveryBundle.priority}" value="#{deliveryEdit.delivery.priority}" size="5"/>

          <h:outputText rendered="#{deliveryEdit.userInAdminRole}" style="white-space:nowrap;" value="#{deliveryBundle.retryPolicy}"/>
          <h:panelGroup rendered="#{deliveryEdit.userInAdminRole}">
            <h:selectOneMenu id="retryOnFail" onchange="retryOnFailChanged()" value="#{deliveryEdit.retryOnFail}">
              <f:selectItem itemValue="off" itemLabel="#{msg['user.edit.retry.off']}"/>
              <f:selectItem itemValue="default" itemLabel="#{msg['user.edit.retry.default']}"/>
              <f:selectItem itemValue="custom" itemLabel="#{msg['user.edit.retry.custom']}"/>
            </h:selectOneMenu>
            <h:outputText value=" "/>
            <h:inputText value="#{deliveryEdit.delivery.retryPolicy}" id="retryPolicy1"/>
          </h:panelGroup>

        <h:outputText rendered="#{deliveryEdit.userInAdminRole}"  id="messageTimeToLiveLabel" style="white-space:nowrap;" value="#{deliveryBundle.messageTimeToLive}"/>
        <eye:inputTime rendered="#{deliveryEdit.userInAdminRole}" id="messageTimeToLive" value="#{deliveryEdit.delivery.messageTimeToLive}" />

        <h:outputText rendered="#{deliveryEdit.userInAdminRole}"  id="vPeriodLabel" style="white-space:nowrap;" value="#{deliveryBundle.validityPeriod}"/>
        <eye:inputTime rendered="#{deliveryEdit.userInAdminRole}" id="vPeriod" value="#{deliveryEdit.delivery.validityPeriod}" />


        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.smsNotificationAddress}"/>
        <h:panelGroup>
          <h:selectBooleanCheckbox id="smsNotif" value="#{deliveryEdit.smsNotificationCheck}" onchange="document.getElementById('sms').disabled = !this.checked;" style="position: relative; top: 2px; left: -3px;"/>
          <h:inputText converterMessage="#{msg['invalid_param_value']} #{deliveryBundle.smsNotificationAddress}" id="sms" converter="addressConverter" value="#{deliveryEdit.smsNotificationAddress}"/>
        </h:panelGroup>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.emailNotificationAddress}"/>
        <h:panelGroup>
          <h:selectBooleanCheckbox id="emailNotif" value="#{deliveryEdit.emailNotificationCheck}" onchange="document.getElementById('email').disabled = !this.checked;" style="position: relative; top: 2px; left: -3px;"/>
          <tr:inputText id="email" value="#{deliveryEdit.emailNotificationAddress}" simple="true"/>
        </h:panelGroup>

        <h:outputText value="#{deliveryBundle.archivate}" rendered="#{deliveryEdit.archivateAvailable}"/>
        <h:panelGroup rendered="#{deliveryEdit.archivateAvailable}">
          <h:selectBooleanCheckbox id="archivate" value="#{deliveryEdit.archivateCheck}" onchange="archivateChanged()" style="position: relative; top: 2px; left: -3px;"/>
          <h:inputText validatorMessage="#{msg['invalid_param_value']} #{deliveryBundle.archivate}" id="archiveTime" value="#{deliveryEdit.archiveTime}">
            <f:validateLongRange/>
          </h:inputText>
        </h:panelGroup>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.singleText}" rendered="#{deliveryEdit.delivery.type.value == 'SingleText'}"/>
        <h:panelGrid columns="1" rendered="#{deliveryEdit.delivery.type.value == 'SingleText'}">
          <tr:inputText value="#{deliveryEdit.delivery.singleText}" rows="3" simple="true"/>
          <h:panelGroup>
            <h:inputText value="#{deliveryEdit.testAddress}" size="21"/>
            <tr:outputText value="&#160;"/>
            <tr:commandLink text="#{msg['test.button']}" action="#{deliveryEdit.sendTest}" shortDesc="#{msg['delivery.details.test.sms']}"/>
          </h:panelGroup>
        </h:panelGrid>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.secretMessage}" rendered="#{deliveryEdit.secret}"/>
        <tr:inputText rows="5" readOnly="true" value="#{deliveryEdit.secretMessage}"  simple="true" rendered="#{deliveryEdit.secret}"/>

        <h:outputText style="white-space:nowrap;" value="#{deliveryBundle.secretFlash}" rendered="#{deliveryEdit.secret}"/>
        <tr:selectBooleanCheckbox readOnly="true" value="#{deliveryEdit.flashSecret}" simple="true" rendered="#{deliveryEdit.secret}"/>

        <h:outputText style="white-space:nowrap; display: #{deliveryEdit.allowUssdPushDeliveries ? '' : 'none'}" value="#{deliveryBundle.useDataSm}"/>
        <h:selectBooleanCheckbox value="#{deliveryEdit.useDataSm}" style="white-space:nowrap; display: #{deliveryEdit.allowUssdPushDeliveries ? '' : 'none'}"/>

        <h:outputText rendered="#{deliveryEdit.allowUssdPushDeliveries}" style="white-space:nowrap;" value="#{deliveryBundle.deliveryMode}"/>
        <h:selectOneMenu converterMessage="#{msg['invalid_param_value']} #{deliveryBundle.deliveryMode}" id="dMode" value="#{deliveryEdit.delivery.deliveryMode}" converter="deliveryTypeConverter"
                         onchange="dModeChanged()"
                         rendered="#{deliveryEdit.allowUssdPushDeliveries}">
          <f:selectItems value="#{deliveryEdit.uniqueDeliveryModes}"/>
        </h:selectOneMenu>

        <h:outputText id="flashLabel" style="white-space:nowrap;" value="#{deliveryBundle.flash}"/>
        <tr:selectBooleanCheckbox id="flash" value="#{deliveryEdit.delivery.flash}" simple="true"/>


        <h:outputText rendered="#{deliveryEdit.userInAdminRole or deliveryEdit.allowUssdPushDeliveries}" id="trModeLabel" style="white-space:nowrap;" value="#{deliveryBundle.transactionMode}"/>
        <tr:selectBooleanCheckbox rendered="#{deliveryEdit.userInAdminRole or deliveryEdit.allowUssdPushDeliveries}"  id="trMode" value="#{deliveryEdit.delivery.transactionMode}" simple="true"/>


      </h:panelGrid>

      <eye:delimiter/>

      <eye:updatableContent  updatePeriod="5">

        <h:panelGrid columns="2" columnClasses="column50ProcWidthTop, columnTopLeftAlign">

          <h:panelGroup>

            <eye:pageSubtitle value="#{msg['delivery.edit.counters']}"/>

            <eye:delimiter/>

            <c:set var="total" value="0"/>
            <h:panelGrid columns="2" styleClass="properties_list" style="padding-left: 10px" columnClasses="column100WidthTopLeft, columnTopLeftAlign" >
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['message.state.New']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.newMessages + deliveryEdit.status.processMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.newMessages + deliveryEdit.status.processMessages + deliveryEdit.status.retriedMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['message.state.Retry']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.retriedMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['message.state.Sent']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.sentMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.sentMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['message.state.Delivered']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.deliveredMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.deliveredMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['message.state.Failed']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.failedMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.failedMessages}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold" value="#{msg['message.state.Expired']}"/>
              <h:outputText style="white-space:nowrap;" value="#{deliveryEdit.status.expiredMessages}"/>
              <c:set var="total" value="#{total + deliveryEdit.status.expiredMessages}"/>

              <h:outputText style="white-space:nowrap; font-weight: bold; border-bottom: 1px solid BLACK;" value="#{msg['delivery.messages.total']}"/>
              <h:outputText style="white-space:nowrap; font-weight: bold; border-bottom: 1px solid BLACK;" value="#{total}"/>
            </h:panelGrid>

          </h:panelGroup>

          <h:panelGroup>
            <c:set var="nm" value="delivery.status.#{deliveryEdit.status.deliveryState.status}"/>

            <eye:pageSubtitle value="#{msg['delivery.edit.status']} : #{msg[nm]}"/>

            <eye:delimiter/>

            <h:panelGrid columns="2" styleClass="properties_list" style="padding-left: 10px" columnClasses="column100Width, columnTopLeftAlign" >
              <c:forEach items="#{deliveryEdit.statusHistory.historyItems}" var="item">

                <c:set var="nm1" value="delivery.status.#{item.status}"/>

                <tr:outputText value="#{item.date}" inlineStyle="white-space:nowrap;font-weight: bold">
                  <f:convertDateTime dateStyle="short" type="both"/>
                </tr:outputText>

                <h:outputText value=" : #{msg[nm1]}"/>
              </c:forEach>
            </h:panelGrid>
          </h:panelGroup>

        </h:panelGrid>

      </eye:updatableContent>

      <eye:delimiter/>

      <eye:buttons>
        <eye:button>
          <tr:commandLink text="#{msg['done.button']}" action="#{deliveryEdit.save}" shortDesc="#{msg['delivery.details.save']}"/>
        </eye:button>
        <eye:button>
          <tr:commandLink text="#{msg['cancel.button']}" action="#{deliveryEdit.cancel}" immediate="true" shortDesc="#{msg['delivery.details.cancel']}"/>
        </eye:button>
        <eye:space/>
        <eye:button>
          <eye:menubar label="#{msg['informer.deliveries.stats']} ...">
            <eye:menubaritem>
              <tr:commandLink text="#{msg['informer.stats.by.messages']}" action="#{deliveryMessagesByPeriod.setDeliveryParam}" shortDesc="#{msg['delivery.details.stats.mess']}">
                <f:param name="delivery" value="#{deliveryEdit.delivery.id}"/>
                <f:param name="stats_come_back" value="DELIVERY_EDIT"/>
                <f:param name="stats_come_back_params" value="#{deliveryEdit.delivery.id}"/>
              </tr:commandLink>
            </eye:menubaritem>
            <eye:menubaritem>
              <tr:commandLink text="#{msg['informer.stats.by.error']}" action="#{messErrors.setDeliveryParam}" actionListener="#{deliveryEdit.statForSelected}" shortDesc="#{msg['delivery.details.stats.errors']}">
                <f:param name="errors_stats_come_back" value="DELIVERY_EDIT"/>
                <f:param name="errors_stats_come_back_params" value="#{deliveryEdit.delivery.id}"/>
              </tr:commandLink>
            </eye:menubaritem>
          </eye:menubar>
        </eye:button>
        <eye:button>
          <tr:commandLink text="#{msg['informer.deliveries.messages']}" action="MESSAGES" shortDesc="#{msg['delivery.details.msgs']}">
            <f:param name="delivery" value="#{deliveryEdit.delivery.id}"/>
            <f:param name="#{deliveryEdit.messagesComeBackParamsName}" value="#{deliveryEdit.delivery.id}"/>
            <f:param name="#{deliveryEdit.messagesComeBackName}" value="DELIVERY_EDIT"/>
          </tr:commandLink>
        </eye:button>
      </eye:buttons>

      <script type="text/javascript" language="javascript">

        function dModeChanged() {
          var d = (document.getElementById('dMode') != null &amp;&amp; document.getElementById('dMode').value != 'SMS') ? 'none' : '';
          document.getElementById('flashLabel').style.display = d;
          document.getElementById('flash').style.display = d;
          var e = document.getElementById('trMode');
          if(e != null) {
            e.style.display = d;
            document.getElementById('trModeLabel').style.display = d;
          }
        }

        function retryOnFailChanged() {
          var e = document.getElementById('retryOnFail');
          if(e != null) {
            var d = e.options[2].selected ? '' : 'none';
            var d1 = (e.options[0].selected) ? 'none' : '';
            document.getElementById('retryPolicy1').style.display=d;
            document.getElementById("messageTimeToLiveLabel").style.display=d1;
            document.getElementById("messageTimeToLive").style.display=d1;
          }
        }

        function archivateChanged() {
          var e = document.getElementById('archivate');
          var e1 = document.getElementById('archiveTime');
          if(e != null) {
            e1.disabled= !e.checked;
          }
        }

        archivateChanged();

        retryOnFailChanged();

        dModeChanged();

        document.getElementById('sms').disabled = !document.getElementById('smsNotif').checked;
        document.getElementById('email').disabled = !document.getElementById('emailNotif').checked;
      </script>

    </tr:form>

  </ui:define>

</ui:composition>


</html>