<project default="update" name="Sibinco Tomcat Authentication Module">

  <property file="../build.properties"/>
  <property environment="env"/>
  <condition property="WEBBUILD_DIR" value="${BUILD_DIR}">
        <not>
            <isset property="WEBBUILD_DIR"/>
        </not>
  </condition>
  <condition property="WEBDISTR_DIR" value="${DISTR_DIR}">
        <not>
            <isset property="WEBDISTR_DIR"/>
        </not>
  </condition>
    <condition property="CATALINA_BASE" value="${WEBDISTR_DIR}">
        <not>
            <isset property="CATALINA_BASE"/>
        </not>
    </condition>
    <condition property="CATALINA_HOME" value="${CATALINA_BASE}/tomcat">
        <not>
            <isset property="CATALINA_HOME"/>
        </not>
    </condition>
  <property name="jmx_jar" location="${CATALINA_HOME}/bin/jmx.jar"/>
  <property name="catalina_jar" location="${CATALINA_HOME}/server/lib/catalina.jar"/>
  <property name="java_out" location="${WEBBUILD_DIR}/tomcat_auth_lib/classes/"/>
  <property name="jar_out" location="${WEBBUILD_DIR}/jars/"/>

  <target name="init">
    <tstamp/>
    <mkdir dir="${java_out}server/classes"/>
    <mkdir dir="${java_out}common/classes"/>
    <mkdir dir="${java_out}webapp/classes"/>
    <mkdir dir="${jar_out}"/>
  </target>

  <target name="compile" depends="init" description="compile the sources">
    <javac srcdir="common/src"
           destdir="${java_out}common/classes"
           classpath="${jmx_jar}:${catalina_jar}"
           includeantruntime="false"/>
    <javac srcdir="server/src"
           destdir="${java_out}server/classes"
           classpath="${jmx_jar}:${catalina_jar}:${java_out}common/classes"
           includeantruntime="false"/>
    <javac srcdir="webapp/src"
           destdir="${java_out}webapp/classes"
           classpath="${jmx_jar}:${catalina_jar}:${java_out}common/classes:${java_out}server/classes"
           includeantruntime="false"/>
  </target>

  <target name="build" depends="compile" description="generate the distribution">
    <jar jarfile="${jar_out}/sibinco_tomcat_auth_server.jar" basedir="${java_out}server/classes"/>
    <jar jarfile="${jar_out}/sibinco_tomcat_auth_common.jar" basedir="${java_out}common/classes"/>
    <jar jarfile="${jar_out}/sibinco_tomcat_auth.jar"        basedir="${java_out}webapp/classes"/>
  </target>

  <target name="rebuild" depends="clean,build" description="rebuild"/>

  <target name="install" depends="build">
    <copy file="${jar_out}/sibinco_tomcat_auth_server.jar" todir="${CATALINA_HOME}/server/lib" preservelastmodified="yes"/>
    <copy file="${jar_out}/sibinco_tomcat_auth_common.jar" todir="${CATALINA_HOME}/common/lib" preservelastmodified="yes"/>
  </target>

  <target name="update" depends="install"/>

  <target name="clean" description="clean up">
    <delete dir="${java_out}server/classes"/>
    <delete dir="${java_out}common/classes"/>
    <delete dir="${java_out}webapp/classes"/>
    <delete file="${jar_out}/sibinco_tomcat_auth_server.jar"/>
    <delete file="${jar_out}/sibinco_tomcat_auth_common.jar"/>
    <delete file="${jar_out}/sibinco_tomcat_auth.jar"/>
  </target>
</project>
